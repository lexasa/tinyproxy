/* Timestamp: 1447875625 */
window.getVPAIDAd = function(){
	(function(){
		var s = document.createElement('STYLE');
		s.innerHTML = '.ad_controls_place {position: relative;outline: none;z-index: 0;font: 400 14px/1.2 \'Roboto\', sans-serif;overflow: hidden;}.ad_controls_place:-webkit-full-screen{position: absolute;top: 0;left: 0;width: 100% !important;height: 100% !important;}.ad_controls_place:-moz-full-screen{top: 0;left: 0;position: absolute;width: 100% !important;height: 100% !important;}.ad_controls_place .no-animate,.ad_controls_place .no-animate *{transition: none !important;}.ad_controls_place .error.fatal {position: absolute;top: 45%;width: 100%;color: rgb(255, 82, 82);font-size: 20pt;text-align: center;}.ad_controls_place .loader {position: absolute;left: 0;right: 0;top: 0;bottom: 0;background: rgba(0, 0, 0, 0.7);z-index: -1;opacity: 0;transition: opacity ease .3s;}.ad_controls_place.wait .loader {opacity: 1;z-index: 10;}.ad_controls_place * {padding: 0;margin: 0;box-sizing: border-box;}.ad_controls_place > .screen {width: 100%;height: 100%;top: 0;position: absolute;background: black;z-index: 0;}.ad_controls_place .poster {position: absolute;left: 0;top: 0;width: 100%;height: 100%;background-repeat: no-repeat;background-position: 50% 50%;background-size: contain;background-color: black;cursor: pointer;z-index: 10;}.ad_controls_place .poster svg {position: absolute;width: 160px;height: 160px;left: 50%;top: 50%;margin: -80px 0 0 -80px;}.ad_controls_place .poster:hover svg > path {fill: rgba(255,255,255,0.9);}.Ad {position: absolute;left: 0;top: 0;width: 100%;height: 100%;z-index: 1000;background: #000;outline: none;}.ad_controls_place .non-linear-ads {position: absolute;right: 10px;bottom: 60px;cursor: pointer;transition: opacity ease 1s;}.ad_controls_place .non-linear-ads .close {position: absolute;right: 0px;top: 0px;border: 1px solid #444;background: #fff;text-align: center;width: 20px;height: 20px;cursor: pointer;}.ad_controls_place>.controls {position: absolute;left: 0px;right: 0px;bottom: 0px;height: 69px;background: none;background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAABFCAYAAACL3IzzAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NTc3MiwgMjAxNC8wMS8xMy0xOTo0NDowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTQgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjBCQUNBRUVFNjM5QjExRTVBQjkzRDJCRDQyRkU1MEE0IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjBCQUNBRUVGNjM5QjExRTVBQjkzRDJCRDQyRkU1MEE0Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MEJBQ0FFRUM2MzlCMTFFNUFCOTNEMkJENDJGRTUwQTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MEJBQ0FFRUQ2MzlCMTFFNUFCOTNEMkJENDJGRTUwQTQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4PyzKNAAAAbElEQVR42myPUQ6AMAhDK9u1jB/e/0xV6NaQ6M/SBy0w3NcZAfAIEBEECvNJJLaqGjGMw4lUSgzjVlVLxAdnjk9lM9+aUKrmcWqvVI+5oZgbZeH0yo4yr/vWvIZ90TpIX9Xh8NCfmxfK/AgwACr2StbF5TFoAAAAAElFTkSuQmCC\');z-index: 9;opacity: 1;transition: opacity ease .3s;}.hide > .controls {opacity: 0;}.ad_controls_place>.controls svg {fill: #FFFFFF;}.ad_controls_place>.controls svg:hover {fill: #FCC010;}.ad_controls_place>.controls .play-pause {position: absolute;left: 20px;bottom: 10px;cursor: pointer;width: 24px;height: 24px;overflow: hidden;}.ad_controls_place>.controls .play-pause path.play {display: block;}.ad_controls_place>.controls .play-pause path.pause {display: none;}.ad_controls_place.playing>.controls .play-pause path.play {display: none;}.ad_controls_place.playing>.controls .play-pause path.pause {display: block;}.ad_controls_place>.controls .timer {position: absolute;bottom: 12px;left: 50px;color: #fff;font-size: 12px;padding: 0;line-height: 20px;height: 20px;vertical-align: middle;}.ad_controls_place>.controls .time-label {position: absolute;color: #fff;background: #000;border-radius: 5px;padding: 5px 10px;text-align: center;width: 70px;bottom: 60px;margin-left: -35px;opacity: 0;cursor: default;transition: opacity ease .5s;}.ad_controls_place>.controls .time-label:after {content: \"\";position: absolute;width: 0;height: 0;top: 100%;left: 50%;border-style: solid;border-color: transparent;border-width: 5px;border-top-color: #000;margin-left: -5px;}.ad_controls_place>.controls .time-label.show {opacity: 1;}.ad_controls_place>.controls .progress {position: absolute;left: 0px;right: 0px;bottom: 45px;height: 17px;background: none;cursor: pointer;border-bottom: 5px solid rgba(108, 108, 108, 0.5);z-index: 0;}.ad_controls_place>.controls .progress.readonly {border-bottom-width: 2px;cursor: default;}.ad_controls_place>.controls .progress .load {position: absolute;height: 5px;left: 0;bottom: -5px;background: rgba(154, 154, 156, 0.5);z-index: 0;transition: width ease .3s;}.ad_controls_place>.controls .progress.readonly .load {height: 2px;bottom: -2px;}.ad_controls_place>.controls .progress .play {position: absolute;left: 0;bottom: -5px;height: 5px;background: #FCC010;z-index: 10;transition: width ease .3s;}.ad_controls_place>.controls .progress.readonly .play {background: #BEBEBE;height: 2px;bottom: -2px;}.ad_controls_place>.controls .progress.readonly .play:after {display: none;}.ad_controls_place>.controls .progress .play:after {content: \"\";position: absolute;right: 0px;top: 0px;background: inherit;border-radius: 50%;width: 0px;height: 0px;border: none;margin: 3px 0 0 0;transition:margin ease .3s,width ease .3s,height ease .3s;}.ad_controls_place>.controls .progress:hover .play:after {width: 12px;height: 12px;margin: -3px -6px 0 0;}.ad_controls_place>.controls .tray {position: absolute;bottom: 10px;right: 20px;height: 24px;white-space: nowrap;}.ad_controls_place>.controls .tray > *{position: relative;width: 24px;height: 24px;overflow: hidden;margin: 0 0 0 15px;display: inline-block;cursor: pointer;vertical-align: middle;}.ad_controls_place>.controls .mute {cursor: default !important;}.ad_controls_place>.controls .mute svg {fill: #fff !important;}.ad_controls_place>.controls .mute svg .mute {display: none;}.ad_controls_place.muted>.controls .mute svg .unmute {display: none;}.ad_controls_place.muted>.controls .mute svg .mute {display: block;}.ad_controls_place>.controls .volume {position: relative;width: 100px;height: 5px;background: #6C6C6C;margin-top: -1px;margin-left: 5px;overflow: visible;}.ad_controls_place>.controls .volume .level{position: absolute;left: 0;height: 100%;background: #FFFFFF;transition: width ease .3s;}.ad_controls_place>.controls .volume .level:after {content: \"\";position: absolute;right: 0px;top: 0px;background: inherit;border-radius: 50%;width: 0px;height: 0px;border: none;margin: 3px 0 0 0;transition:margin ease .3s,width ease .3s,height ease .3s;}.ad_controls_place>.controls .volume:hover .level:after {width: 12px;height: 12px;margin: -3px -6px 0 0;}.ad_controls_place.fullscreen .tray .fullscreen .off { display: block; }.ad_controls_place.fullscreen .tray .fullscreen .on { display: none; }.ad_controls_place .tray .fullscreen .off { display: none; }.ad_controls_place .tray .fullscreen .on { display: block; }.ad_controls_place .tray .hq {width: 32px;}.ad_controls_place .ad-info {position: absolute;right: 5px;vertical-align: middle;top: 10px;color: #fff;font-size: 13pt;z-index: 10;background: rgba(0,0,0,0.5);padding: 5px 10px;}.ad_controls_place .ad-info .ad-link{color: #fff;border-bottom: 1px dashed #fff;text-decoration: none;cursor: pointer;}.ad_controls_place .ad-skip {position: absolute;display: table;right: 5px;bottom: 70px;padding: 5px;background: rgba(0,0,0,0.4);cursor: pointer;z-index: 10;}.ad_controls_place .ad-skip  > .message {display: table-cell;color: #fff;vertical-align: middle;text-align: center;font-size: 12pt;padding-right: 10px;}.ad_controls_place .ad-skip > img {display: table-cell;height: 60px;}';
		document.head.appendChild(s);
	})();	function addClass(o, c){
	var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g");
	if (re.test(o.className)) return;
	o.className = (o.className + " " + c).replace(/\s+/g, " ").replace(/(^ | $)/g, "");
}

function removeClass(o, c){
	var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g");
	o.className = o.className.replace(re, "$1").replace(/\s+/g, " ").replace(/(^ | $)/g, "");
}

function hasClass(o, c){
	var re = new RegExp("(^|\\s)" + c + "(\\s|$)", "g");
	return re.test(o.className);
}

function map(array, callback){
	if(array){
		for(var i=0; i<array.length; i++){
			if(callback(array[i])===false) break;
		}
	}
}

function keys(o){
	var res = [];
	for(var i in o) if(o.hasOwnProperty(i)){
		res.push(i);
	}
	return res;
}

function is_object(item){
	return typeof item === 'object' && item!==null && item.constructor === Object;
}

function is_empty(item){
	return item ? (is_object(item) ? keys(item).length==0 : item.length==0) : true;
}

function fill(a, b){
	map(keys(b), function(k){
		if(is_object(a[k]) && is_object(b[k]) && !is_empty(a[k])){
			fill(a[k], b[k]);
		}else if(typeof a[k]!=='undefined'){
			a[k] = b[k];
		} 
	});
	return a;
}

function extend(a, b){
	map(keys(b), function(k){
		if(is_object(a[k]) && is_object(b[k]) && !is_empty(a[k])){
			extend(a[k], b[k]);
		}else{
			a[k] = b[k];
		} 
	});
	return a;
}

function every(array, callback){
	for(var i=0; i<array.length; i++){
		if(!callback(array[i])){
			return false;
		}
	}
	return true;
}

function on(elm, type, handler, scope){
	if(type instanceof Array){
		for(var i=0; i<type.length; i++){
			on(elm, type[i], handler, scope);
		}
	}else{
		var event_name = type.split('.')[0];
		var tag = type.split('.')[1] || null;
		var h = function(event){
			if(handler.call(scope ? scope : elm, event)===false){
				event.stopPropagation();
				event.preventDefault();
			}
		};

		if(!elm.__events){
			elm.__events = {};
		}

		elm.__events = elm.__events || {};
		elm.__events[event_name] = elm.__events[event_name] || [];

		elm.__events[event_name].push({
			tag: tag,
			handler: h
		});
		elm.addEventListener(event_name, h, false);
	}
}

function off(elm, type){
	if(type instanceof Array){
		for(var i=0; i<type.length; i++){
			off(elm, type[i]);
		}
	}else{
		var event_name = type.split('.')[0];
		var tag = type.split('.')[1] || null;
		var a = elm.__events[event_name];

		for(var i=0; i<a.length; i++){
			if(a[i] && (tag===null || a[i].tag==tag)){
				elm.removeEventListener(event_name, a[i].handler, false);
				a[i] = null;
			}
		}
	}
}

function html(html){
	var e = document.createElement('DIV');
	e.innerHTML = html;
	return e.firstChild;
}

function flash_support(){
	var s = navigator.mimeTypes['application/x-shockwave-flash']
		&& navigator.mimeTypes['application/x-shockwave-flash'].enabledPlugin
		&& navigator.mimeTypes['application/x-shockwave-flash'].enabledPlugin.description;
	return !!s;
}

function getCookie(key, default_value){
	var cookie = {};
	map(document.cookie.split(';'), function(p){
		var o = p.split('=');
		if(o.length==2){
			cookie[o[0].trim()] = o[1].trim();
		}
	});
	return cookie[key] && !isNaN(cookie[key]) ? cookie[key] : default_value;
}

function setCookie(key, value){
	document.cookie = key+"="+value+"; path=/";
}

function load(url, callback){
	var self = this;
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState==4){
			callback(xhr.status==200, xhr);
		}
	};
	xhr.open('GET', url, true);
	xhr.send(null);
	return xhr;
}// 100 XML parsing error. 
// 101 VAST schema validation error.
// 102 VAST version of response not supported.
// 200 Trafficking error. Video player received an Ad type that it was not expecting and/or cannot display.
// 201 Video player expecting different linearity.
// 202 Video player expecting different duration.
// 203 Video player expecting different size.
// 300 General Wrapper error.
// 301 Timeout of VAST URI provided in Wrapper element, or of VAST URI provided in a subsequent Wrapper element. (URI was either unavailable or reached a timeout as defined by the video player.)
// 302 Wrapper limit reached, as defined by the video player. Too many Wrapper responses have been received with no InLine response. 
// 303 No Ads VAST response after one or more Wrappers. 
// 400 General Linear error. Video player is unable to display the Linear Ad.
// 401 File not found. Unable to find Linear/MediaFile from URI.
// 402 Timeout of MediaFile URI.
// 403 Couldn’t find MediaFile that is supported by this video player, based on the attributes of the MediaFile element.
// 405 Problem displaying MediaFile. Video player found a MediaFile with supported type but couldn’t display it. MediaFile may include: unsupported codecs, different MIME type than MediaFile@type, unsupported delivery method, etc.
// 500 General NonLinearAds error.
// 501 Unable to display NonLinear Ad because creative dimensions do not align with creative  display area (i.e. creative dimension too large).
// 502 Unable to fetch NonLinearAds/NonLinear resource.
// 503 Couldn’t find NonLinear resource with supported type.
// 600 General CompanionAds error.
// 601 Unable to display Companion because creative dimensions do not fit within Companion display area (i.e., no available space).
// 602 Unable to display Required Companion.
// 603 Unable to fetch CompanionAds/Companion resource.
// 604 Couldn’t find Companion resource with supported type.
// 900 Undefined Error.
// 901 General VPAID error.

CustomObject = {

	proxy: function(type, receiver){
		if(type instanceof Array){
			for(var i=0; i<type.length; i++){
				this.proxy(type[i], receiver);
			}
		}else{
			this.on(type, function(){
				var args = Array.prototype.splice.call(arguments, 1);
				receiver.trigger.apply(receiver, [type].concat(args));
			});
		}
	},

	on: function(type, handler, scope){
		var self = this;
		this._handlers = this._handlers || {};
		if(type instanceof Array){
			for(var i=0; i<type.length; i++){
				this.on(type[i], handler, scope);
			}
		}else{
			if(typeof this._handlers[type]==='undefined'){
				this._handlers[type] = [];
			}
			this._handlers[type].push({
				_id: this._handlers[type].length,
				handler: handler,
				scope: scope || this,
				remove: function(){
					self._handlers[type][this._id] = null;
				}
			});
		}
		return this;
	},

	trigger: function(type){
		this._handlers = this._handlers || {};

		var args = Array.prototype.splice.call(arguments, 1);
		var handlers = (this._handlers[type]||[]).concat(this._handlers['*']||[]);
		for(var i=0; i<handlers.length; i++){
			if(h = handlers[i]){
				var ret = h.handler.apply(h.scope, [{type: type, handler: h}].concat(args));
				if(ret===false){
					break;
				}				
			}
		}

		return this;
	},
};function extendUrl(url, params){
	var t = ((new Date).getTime()/1000)|0;
	var params = extend({
		'CACHEBUSTER': t,
		'CACHE_BUSTER': t,
		'timestamp': t,
	}, params);
	map(keys(params), function(name){
		url = url.replace('['+name+']', encodeURIComponent(params[name]));
	});
	return url;
};

function firePixel(url, params){
	var pixel = new Image;
	var url = extendUrl(url, params);
	var glue = url.indexOf('?')==-1 ? '?' : '&';
	// pixel.src = url+glue+((new Date)-0);
	pixel.src = url;
}

function openWindow(url, params){
	window.open(extendUrl(url, params), '_blank');
}

function parseTrackingEvents(xml){
	var events = {};
	if(xml){
		map(xml.getElementsByTagName("Tracking"), function(tracking_xml){
			var event = {};
			var name = tracking_xml.getAttribute("event");
			if(typeof events[name]==='undefined'){
				events[name] = [];
			}
			event.content = tracking_xml.textContent;
			map(tracking_xml.attributes, function(attr){
				event[attr.name] = attr.value;
			});
			events[name].push(event);
		});
	}
	return events;
}

function parseSkipOffset(str){
	str = str.trim();
	if(match = /^(\d{1,2}):(\d{1,2}):(\d{1,2})/.exec(str)){
		return {
			type: 'seconds',
			value:  parseInt(match[1])*3600 + parseInt(match[2])*60 + parseInt(match[3]),
		};
	}
	if(match = /^(\d{1,3})%$/.exec(str)){
		return {
			type: 'percent',
			value:  parseInt(match[1]),
		};
	}
}

function createBanner(type, src){
	if(type=='html'){
		elm = document.createElement('DIV');
		elm.innerHTML = src;
	}else if(type=='iframe'){
		elm = document.createElement('IFRAME');
		elm.src = src;
		elm.style.border = 'none';
		elm.scrolling = 'no';
	}else if(type=='application/x-shockwave-flash'){
		elm = document.createElement('OBJECT');
		elm.setAttribute('type', 'application/x-shockwave-flash');
		elm.setAttribute('data', src);
	}else{
		elm = document.createElement('IMG');
		elm.src = src;
	}
	return elm;
}

function processTracking(event){
	if(event && event.length){
		for(var i=0; i<event.length; i++){
			firePixel(event[i].content);
		}
	}
}function VPAIDLinear(options){
	var self = this;

	this.type;
	this.src;
	this.creative;
	extend(this, options);

	this.vpaid = null;

	this.on('vpaidevent', function(e, event, args){

		console.log('>>>VPAID Log:', event, args)

		switch(event){
			case 'AdLoaded':
				self.vpaid.startAd();
			break;
			case 'AdClickThru':
				var url = args[0];
				var playerHandles = args[2];
				self.trigger('vastevent', 'clickthru', {
					click_through: url,
					no_fire_pixel: !playerHandles,
				}, self);
			break;
			case 'AdSkipped':
				self.trigger('vastevent', 'skip', {}, self);
			break;
			case 'AdStopped':
				self.trigger('vastevent', 'complete', {}, self);
			break;
			case 'AdError':
				self.trigger('vasterror', 901, args);
			break;
			case 'AdStarted':
				self.trigger('vastevent', 'start', {}, self);
				self.trigger('vastevent', 'creativeView', {}, self);
			break;
			case 'AdVideoFirstQuartile':
				self.trigger('vastevent', 'firstQuartile', {}, self);
			break;
			case 'AdVideoMidpoint':
				self.trigger('vastevent', 'midpoint', {}, self);
			break;
			case 'AdVideoThirdQuartile':
				self.trigger('vastevent', 'thirdQuartile', {}, self);
			break;
		}
	});
}

VPAIDLinear.prototype = extend(Object.create(CustomObject), {

	vpaidEventsList: [
		'AdLoaded',
		'AdSkipped',
		'AdStarted',
		'AdStopped',
		'AdLinearChange',
		'AdSkippableStateChange',
		'AdSizeChange',
		'AdDurationChange',
		'AdExpandedChange',
		'AdRemainingTimeChange',
		'AdVolumeChange',
		'AdImpression',
		'AdVideoStart',
		'AdVideoFirstQuartile',
		'AdVideoMidpoint',
		'AdVideoThirdQuartile',
		'AdVideoComplete',
		'AdClickThru',
		'AdInteraction',
		'AdUserAcceptInvitation',
		'AdUserMinimize',
		'AdUserClose',
		'AdPaused',
		'AdPlaying',
		'AdLog',
		'AdError',
	],

	show: function(place, width, height, options){
		var self = this;
		var iframe = html('<iframe id="iframe" frameborder="no" scrolling="no" allowfullscreen></iframe>');
		iframe.width = width;
		iframe.height = height;
		place.appendChild(iframe);

		var _t = setTimeout(function(){
			self.trigger('vasterror', 900, 'Timeout VPAID AdLoaded event');
		}, options.timeout);

		this.on('vpaidevent', function(e, event){
			if(event=='AdLoaded' || event=='AdStarted' || event=='AdError'){
				clearTimeout(_t);
			}
		});

		if(this.type=='application/x-shockwave-flash'){
			this.showFlash(iframe, width, height, options);
		}else{
			this.showJS(iframe, width, height, options, iframe);
		}
	},

	showFlash: function(iframe, width, height, options){
		var self = this;
		var doc = iframe.contentDocument;
		var win = iframe.contentWindow;

		var ready_fn_name = "_custom_player_vpaid_on_ready"+Math.random().toString(16).split('.')[1];
		var error_fn_name = "_custom_player_vpaid_on_error"+Math.random().toString(16).split('.')[1];

		var subscribe = function(type, fn){
			var n = '_custom_player_vpaid_' + type + Math.random().toString(16).split('.')[1]
			iframe.contentWindow[n] = fn;
			self.vpaid.subscribe(type, n);
		}

		iframe.contentWindow[error_fn_name] = function(){
			self.trigger('vpaidevent', 'AdError');
		};

		iframe.contentWindow[ready_fn_name] = function(){
			self.vpaid = iframe.contentWindow.vpaid;

			console.log('--VPAID version:', self.vpaid.handshakeVersion('2.0'));
			console.log('getAdLinear:', self.vpaid.getAdLinear());

			subscribe('AdLoaded', function(){
				self.vpaid.startAd();
			});

			map(self.vpaidEventsList, function(event){
				subscribe(event, function(args){
					self.trigger('vpaidevent', event, args);
				});
			});

			self.vpaid.initAd(width, height, "normal", 500, self.creative.params, "");
		};

		doc.open();
		doc.write(
			'<body style="padding:0; margin:0; width:100%; height:100%;">'+
				'<object id="vpaid" type="application/x-shockwave-flash" width="100%" height="100%" data="'+options.vpaid_flash_bridge+'">'+
					'<param name="allowScriptAccess" value="always"></param>'+
					'<param name="allowNetworking" value="all"></param>'+
					'<param name="wmode" value="transparent">'+
					'<param name="flashvars" value="'+
						'onReady='+ready_fn_name+
						'&onError='+error_fn_name+
						'&src='+encodeURIComponent(this.src)+
					'"></param>'+
				'</object>'+
			'</body>'
		);
		doc.close();

		console.log(this);
	},

	showJS: function(iframe, width, height, options){
		var self = this;

		iframe.contentWindow.trigger_error = function(){
			self.trigger('vpaidevent', 'AdError', 'Can\'t load vpaid file');
		};

		iframe.contentWindow.trigger_load = function(){
			var getVPAIDAd = iframe.contentWindow.getVPAIDAd;

			if(typeof getVPAIDAd!=='function'){
				self.trigger('vasterror', 901, 'General VPAID error.', self.creative);
				return;
			}
			self.vpaid = getVPAIDAd();

			map(self.vpaidEventsList, function(event){
				self.vpaid.subscribe(function(){
					self.trigger('vpaidevent', event, arguments);
				}, event);
			});

			self.vpaid.initAd(width, height, 'normal', 500, self.creative.params, {
				slot: iframe.contentDocument.body,
			});
		};

		iframe.contentDocument.open();
		iframe.contentDocument.write(
			'<body style="margin:0; padding:0; width:100%; height:100%;">'+
				'<script src="'+this.src+'" onload="trigger_load()" onerror="trigger_error()"></script>'+
			'</body>'
		);
		iframe.contentDocument.close();
	},

	getIsSupport: function(){
		var support_types = [
			'application/javascript',
			'application/x-javascript',
		];
		if(flash_support()){
			support_types.push('application/x-shockwave-flash');
		}
		return support_types.indexOf(this.type) > -1;
	}
});
function CustomPlayer(root, options){
	this.root = root;

	this.is_show_poster = false;
	this.is_loading = false;
	this.is_playing = false;
	this.is_muted = false;
	this.is_start_load = false;

	this.duration = null;
	this.sources = [];
	this._handlers = {};
	this._plugins = {};

	this.conf = {
		baseCSSClass: 'customPlayer',
		muted: false,
		autoplay: false,
		sources: [],
		plugins: {},
		defaultVolume: 1,
		allow_backends: keys(this.__backends),
		flash_swf: 'video.swf',
		cookieKeyVolume: null,
	};
	fill(this.conf, options);

	addClass(this.root, this.conf.baseCSSClass);
	
	if(this.conf.plugins){
		this._initPlugins(this.conf.plugins);
	}

	var self = this;
	setTimeout(function(){
		if(self.conf.sources){
			self.setSources(self.conf.sources);
		}
		self._init();
	}, 0);
}

CustomPlayer.prototype = extend(Object.create(CustomObject), {

	__backends: {},
	__plugins: {},

	_init: function(){
		if(this.conf.autoplay){
			this.play();
		}

		if(this.conf.cookieKeyVolume){
			this.setVolume(getCookie(this.conf.cookieKeyVolume, this.conf.defaultVolume));
		}else{
			this.setVolume(this.conf.defaultVolume);
		}

		if(this.conf.muted){
			this.mute();
		}
	},

	_destroyBackend: function(){
		if(this.backend){
			this.backend.destroy();
			this.root.removeChild(this.backend.getElement());
		}
	},

	_initBackend: function(backend_class){
		var self = this;

		this.trigger('waiting');

		if(!(this.backend instanceof backend_class)){
			if(this.backend){
				this._destroyBackend();
			}
			this.backend = new backend_class({
				flash_swf: this.conf.flash_swf,
			});

			this.backend.on('play', function(){
				self.is_playing = true;
			});

			this.backend.on('pause', function(){
				self.is_playing = false;
			});

			this.backend.on('ended', function(){
				self.is_playing = false;
			});

			this.backend.on('error', function(e, code, message){
				self.error(code, message);
			});

			this.backend.on('timeupdate', function(e, time){
				self.trigger('timeupdate', time, self.getDuration())
			});

			this.backend.on('ready', function(){
				this.setVolume(self.volume+0.1);
				this.setVolume(self.volume-0.1);
				this.setVolume(self.volume);
			});

			this.backend.proxy([
				'waiting',
				'playing',
				'seeking',
				'seeked',
				'progress',
				// 'durationchange',
				// 'timeupdate',
				'ended',
				'volumechange',
				'play',
				'canplay',
				'pause',
			], this);

			this.backend.init();

			var backend_elm = this.backend.getElement();
			backend_elm.style.width = '100%';
			backend_elm.style.height = '100%';
			backend_elm.style.position = 'absolute';
			backend_elm.style.left = 0;
			backend_elm.style.top = 0;
			this.root.appendChild(backend_elm);

			this.trigger("backendchange", this.backend);
		}
	},

	_initSources: function(sources){
		var allow_backends = this.conf ? this.conf.allow_backends : keys(this.__backends);
		var backends = this.__backends;

		for(var i=0; i<allow_backends.length; i++){
			var name = allow_backends[i];
			if(typeof backends[name]==='undefined') continue;
			for(var j=0; j<sources.length; j++){
				if(
					backends[name].prototype.isSupported() &&
					backends[name].prototype.canPlayType(sources[j].type)
				){
					this._initBackend(backends[name]);
					this.source = sources[j];

					this.trigger("sourcechange", this.source);
					return true;
				}	
			}
		}
		return false;
	},

	_initPlugins: function(options){
		for(var name in options){
			if(options[name] && (typeof options[name].enabled==='undefined' || options[name].enabled)){
				this._plugins[name] = new this.__plugins[name](this, options[name]);
			}
		}
	},

	//---- API ----
	
	getWidth: function(){
		return this.root.offsetWidth;
	},

	getHeight: function(){
		return this.root.offsetHeight;
	},

	supportMedia: function(type){
		var allow_backends = this.conf ? this.conf.allow_backends : keys(this.__backends);
		var backends = this.__backends;
		for(var i=0; i<allow_backends.length; i++){
			var name = allow_backends[i];
			if(typeof backends[name]==='undefined') continue;
			if(
				backends[name].prototype.isSupported() &&
				backends[name].prototype.canPlayType(type)
			){
				return true;
			}
		}
		return false;	
	},

	destroy: function(){
		if(this.backend){
			this._destroyBackend();
			this.backend = null;
		}
		this._handlers = {};
		this.root.parentElement.removeChild(this.root);
		return this;
	},

	decodeErrorCode: function(code){
		var map = {
			100: 'We are working to fix this as soon as possible. Thanks for patience.',
			101: 'Your browser can not reproduce this video. Please update your browser for the best viewing experience.',
			102: 'Oops, try again! There is no video.',
			200: 'We are working to fix this as soon as possible. Thanks for patience.',
			201: 'Video temporarily is unavailable, please try again later.',
		};
		return map[code] || 'Unknown error';
	},

	error: function(code, message){
		this.trigger('error', code, message || this.decodeErrorCode(code));
	},

	setSources: function(sources){
		if(sources && sources.length){
			if(this.is_playing){
				this.pause();
			}
			this.source = null;
			this.sources = sources;
		}else{
			this.error(102)
		}
		return this;
	},

	load: function(){
		var self = this;

		if(this.sources && this.sources.length){
			if(this._initSources(this.sources)){
				if(this.backend.is_ready){
					this.backend.setSource(self.source.src, self.source.type);
				}else{
					this.backend.on('ready', function(e){
						e.handler.remove();
						this.setSource(self.source.src, self.source.type);
					});
				}
				this.is_start_load = true;
			}else{
				this.error(101);
			}
		}else{
			this.error(102);
		}
	},

	play: function(){
		if(!this.is_playing){
			this.is_playing = true;

			if(this.is_start_load){
				this.backend.play();
			}else{
				this.on('canplay', function(e){
					e.handler.remove();
					this.backend.play();
				});
				this.load();
			}
		}
		return this;
	},

	pause: function(){
		if(this.is_playing){
			this.backend.pause();
			this.is_playing = false;
		}
		return this;
	},

	getVolume: function(){
		if(this.backend){
			this.volume = this.backend.getVolume();
		}
		return this.volume;
	},

	setVolume: function(value){
		this.volume = Math.min(1, Math.max(0, value));

		if(this.conf.cookieKeyVolume){
			setCookie(this.conf.cookieKeyVolume, this.volume);
		}

		this.trigger('volumechange', this.volume);
		if(this.backend){
			this.backend.setVolume(this.volume);
		}
	},

	mute: function(){
		this._old_volume = this.getVolume();
		this.setVolume(0);
	},

	unmute: function(){
		this.setVolume(this._old_volume||1);
	},

	getDuration: function(){
		return this.backend.getDuration();
	},

	getCurrentTime: function(){
		return this.backend.getCurrentTime();
	},

	setProgress: function(value){
		var time = this.getDuration() / 100 * value;
		this.backend.setCurrentTime(time);
	},

	getProgress: function(){
		if(this.backend){
			return this.getCurrentTime() / this.getDuration() * 100;
		}else{
			return 0;
		}
	},

});
		HTML5Backend = (function(){

	
	
	function HTML5Backend(options){
		this.width = '100%';
		this.height = '100%';
		extend(this, options);

		this.video = document.createElement('VIDEO');
	}

	HTML5Backend.prototype = extend(Object.create(CustomObject), {
		is_ready: false,

		isSupported: function(){
			return typeof document.createElement('VIDEO').play == 'function';
		},

		canPlayType: function(type){
			var native_support = ['maybe', 'probably'].indexOf(document.createElement('VIDEO').canPlayType(type)) > -1;
						return native_support;
		},

		setSource: function(source, type){
			var self = this;

			if(['maybe', 'probably'].indexOf(this.video.canPlayType(type))>-1){
				this.video.src = source;
				this.video.load();
			}
					},

		getElement: function(){
			return this.video;
		},

		destroy: function(){
			this.video.oncontextmenu = null;
		},

		setWidth: function(width){
			this.video.style.width = width;
		},

		setHeight: function(height){
			this.video.style.height = height;
		},

		init: function(){
			var self = this;

			this.setWidth(this.width);
			this.setHeight(this.height);

			this.initEvents();

			this.on('ready', function(){
				self.is_ready = true;
			});

			this.trigger('ready');
		},

		initEvents: function(){
			var self = this;

			// this.on('*', function(e){
			// 	document.body.appendChild(html('<div>'+e.type+'</div>'));
			// });

			this.video.onerror = function(){
				// self.trigger('error', 201);
			};

			this.video.oncontextmenu= function(){
				event.preventDefault();
			};

			this.video.addEventListener('loadedmetadata', function(){
				self.trigger('canplay');
			});

			this.video.addEventListener('durationchange', function(){
				self.trigger('durationchange', this.duration);
			});

			this.video.addEventListener('volumechange', function(){
				self.trigger('volumechange', this.muted ? 0 : this.volume);
			});

			this.video.addEventListener('timeupdate', function(){
				var in_range = false;
				for(var i=0; i<this.buffered.length; i++){
					if(
						this.currentTime > this.buffered.start(i) &&
						this.currentTime < this.buffered.end(i)
					){
						in_range = this.duration-this.buffered.end(i)<0.5 || Math.abs(this.currentTime-this.buffered.end(i)) > 0.5;
						break;
					}
				}
				if(in_range){
					if(self.is_waiting){
						self.trigger('playing');
						self.is_waiting = false;
					}
				}else{
					self.is_waiting = true;
					self.trigger('waiting');
				}

				self.trigger('timeupdate', this.currentTime);
				if(this.duration && this.duration-this.currentTime<0.5){
					self.trigger('ended');
					this.pause();
					this.currentTime = 0;
				}
			});

			this.video.addEventListener('ended', function(){
				self.trigger('ended');
			});

			this.video.addEventListener('waiting', function(){
				self.trigger('waiting');
			});

			this.video.addEventListener('playing', function(){
				self.trigger('playing');
			});

			this.video.addEventListener('play', function(){
				self.trigger('play');
			});

			this.video.addEventListener('pause', function(){
				self.trigger('pause');
			});

			this.video.addEventListener('canplay', function(){
				self.trigger('canplay');
			});

			this.video.addEventListener('seeking', function(){
				self.trigger('seeking');
			});

			this.video.addEventListener('seeked', function(){
				self.trigger('seeked');
			});

			this.video.addEventListener('progress', function(){
				var res = [];
				for(var i=0; i<this.buffered.length; i++){
					res.push([this.buffered.start(i), this.buffered.end(i)]);
				}
				self.trigger('progress', res);
			});
		},

		play: function(){
			this.video.play();
		},

		pause: function(){
			this.video.pause();
		},

		getCurrentTime: function(){
			return this.video.currentTime;
		},

		getDuration: function(){
			return this.video.duration;
		},

		setCurrentTime: function(time){
			if(this.video.readyState!=HTMLMediaElement.HAVE_NOTHING){
				this.video.currentTime = Math.max(0, Math.min(this.video.duration-0.9, time));
			}
		},

		setVolume: function(value){
			value = Math.max(0, Math.min(1, value||0))
			this.video.volume = value;
			this.video.muted = !value;
		},

		getVolume: function(){
			return this.video.volume;
		},

	});

	return HTML5Backend;
})();	CustomPlayer.prototype.__backends.HTML5 = HTML5Backend;
	
function FlashBackend(options){
	this.flash_swf = null;
	fill(this, options);

	this.swf = document.createElement('OBJECT');
};
FlashBackend.prototype = extend(Object.create(CustomObject), {
	is_ready: false,

	_flashFn: function(fn){
		var public_way = 'window';
		var uniq = '__'+Math.random().toString(16).split('.')[1];
		window[uniq] = function(){
			fn.apply(window, arguments);
		};
		return public_way+'.'+uniq;
	},

	init: function(){
		var self = this;

		this.on('ready', function(){
			self.is_ready = true;
		});
		
		this.swf.setAttribute('type', 'application/x-shockwave-flash');
		this.swf.setAttribute('width', '100%');
		this.swf.setAttribute('height', '100%');
		this.swf.setAttribute('data', this.flash_swf);
		addClass(this.swf, 'screen');

		var params = {
			wmode: 'opaque',
			allowScriptAccess: 'always',
			allowNetworking: 'all',
			quality: 'high',
			flashvars: 'readyFunction='+this._flashFn(function(){
				self.initEvents();
			}),
		};
		for(var name in params){
			var e = document.createElement('PARAM');
			e.setAttribute('name', name);
			e.setAttribute('value', params[name]);
			this.swf.appendChild(e);
		}
	},

	isSupported: function(){
		return flash_support();
	},

	canPlayType: function(type){
		return [
			'video/mp4',
			'video/flv',
			'video/x-flv',
			'video/m4v',
			'application/x-mpegURL',
		].indexOf(type) > -1;
	},

	getElement: function(){
		return this.swf;
	},

	destroy: function(){
		clearInterval(this._play_interval);
	},

	initEvents: function(){
		var self = this;
		this.swf.vjs_setProperty("eventProxyFunction", this._flashFn(function(e, type){
			switch(type){
				case 'playing':
					self.trigger('playing');
				break;
				case 'seeked':
					self.trigger('seeked');
				break;
				case 'waiting':
					self.trigger('waiting');
				break;
				case 'ended':
					self.trigger('ended');
				break;
				case 'canplay':
				case 'loadedmetadata':
					self.trigger('canplay');
				break;
				case 'play':
					self.trigger('play');
				break;
				case 'volumechange':
					self.trigger('volumechange', self.getVolume());
				break;
				case 'durationchange':
					self.trigger('durationchange', self.getDuration());
				break;
			}
		}));

		this.swf.vjs_setProperty("errorEventProxyFunction", this._flashFn(function(id, error){
			switch(error){
				case 'srcnotfound':
					self.trigger('error', 201);
				break;
				default:
					self.trigger('error', 200);
			}
		}));

		this.on('play', function(){
			self.__timeupdate = setInterval(function(){
				self.trigger('progress', [[0, self.swf.vjs_getProperty('buffered')]]);
				self.trigger('timeupdate', self.getCurrentTime());
			}, 500);
		});

		this.on(['pause', 'ended'], function(){
			clearInterval(self.__timeupdate);
		});

		this.trigger('ready');
	},

	setSource: function(source){
		this.swf.vjs_src(source);
	},

	play: function(){
		this.swf.vjs_play();
	},

	pause: function(){
		this.swf.vjs_pause();
		this.trigger('pause');
	},

	getCurrentTime: function(){
		if(this.swf.vjs_getProperty){
			return this.swf.vjs_getProperty('currentTime');
		}
		return 0;
	},

	getDuration: function(){
		if(this.swf.vjs_getProperty){
			return this.swf.vjs_getProperty('duration');
		}
		return 0;
	},

	setCurrentTime: function(time){
		this.swf.vjs_setProperty('currentTime', time);
	},

	setVolume: function(value){
		this.swf.vjs_setProperty('volume', value);
	},

	getVolume: function(value){
		return this.swf.vjs_getProperty('volume');
	},

});	CustomPlayer.prototype.__backends.Flash = FlashBackend;
function VideoLinear(options){
	var self = this;

	this.type;
	this.src;
	this.creative;
	extend(this, options);

	this.player = null;
	
	this.use_html5 = false;
	this.use_flash = false;
}

VideoLinear.prototype = extend(Object.create(CustomObject), {

	show: function(place, width, height, options){
		var self = this;

		this.player = new CustomPlayer(place, options);

		this.player.on('error', function(){

		});

		this.player.on('ended', function(){
			self.trigger('vastevent', 'complete', {}, self.creative);
		});

		this.player.on('canplay', function(e){
			e.handler.remove();
			self.trigger('start', self);
			self.player.play();
		});

		this.player.on('pause', function(){
			self.trigger('vastevent', 'pause', {}, self.creative);
		});

		this.player.on('resume', function(){
			self.trigger('vastevent', 'resume', {}, self.creative);
		});

		var prevous_volume;
		this.player.on('volumechange', function(e, volume){
			if(volume>0 && prevous_volume==0){
				self.trigger('vastevent', 'unmute', {}, self.creative);
			}
			if(volume==0 && prevous_volume!=0){
				self.trigger('vastevent', 'mute', {}, self.creative);
			}
			prevous_volume = volume;
		});

		var step = 0;
		this.player.on('timeupdate', function(e, time){
			var progress = time / this.getDuration() * 100;
			if(progress>0 && step==0){ step++;
				self.trigger('vastevent', 'start', {}, self.creative);
				self.trigger('vastevent', 'creativeView', {}, self.creative);
			}
			if(progress>25 && step==1){ step++;
				self.trigger('vastevent', 'firstQuartile', {}, self.creative);
			}
			if(progress>50 && step==2){ step++;
				self.trigger('vastevent', 'midpoint', {}, self.creative);
			}
			if(progress>75 && step==3){ step++;
				self.trigger('vastevent', 'thirdQuartile', {}, self.creative);
			}
		});

		this.player.setSources([{src:this.src, type:this.type}]);
		this.player.load();
	},

	getIsSupport: function(){
		return CustomPlayer.prototype.supportMedia(this.type);
	},
	
});
function MediaFile(xml, options){

	this.creative;
	this.is_vpaid = false;
	extend(this, options);

	this.is_error = false;
	
	this.on('vasterror', function(e, code, message, source){
		this.is_error = true;
	});

	this.parse(xml);
}

MediaFile.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){
		var self = this;

		var options = {
			type: xml.getAttribute('type'),
			src: xml.textContent.trim(),
			creative: this.creative,
		};

		this.is_vpaid = this.is_vpaid || (xml.getAttribute('apiFramework') || '').toLowerCase() == 'vpaid';

		if(this.is_vpaid){
			this.media = new VPAIDLinear(options);
		}else{
			this.media = new VideoLinear(options);
		}

		this.media.proxy([
			'vastevent',
			'vasterror',
			'vpaidevent',
			'done',
			'start',
		], self);
	},

	getIsSupport: function(){
		return this.media.getIsSupport();
	},

	show: function(place, width, height, options){
		this.media.show(place, width, height, options);
	},

});
function LinearCreative(xml, options){

	this.place = null;
	this.width;
	this.height;
	this.player_options = {};
	this.vpaid_options = {};
	extend(this, options);

	this.width = this.width || this.place.offsetWidth;
	this.height = this.height || this.place.offsetHeight;

	this.id;
	this.skipoffset = null;
	this.sequence = 1;
	this.is_vpaid = false;
	this.click_through = null;
	this.params = {};
	this.tracking = {};
	this.medias = [];

	this.is_ready = false;
	this.is_error = false;
	this.is_done = false;

	this.on('ready', function(){
		this.is_ready = true;
	});

	this.on('vasterror', function(e, code, message, source){
		this.is_error = true;
		this.place.innerHTML = '';
		this.trigger('error');
	});

	this.on('vastevent', function(e, event, args, source){
		switch(event){
			case 'clickthru':
				if(!args.no_fire_pixel){
					openWindow(args.click_through);
				}
			break;
			case 'skip':
			case 'complete':
				this.trigger('done');
			break;
		}
		processTracking(this.tracking[event]);
	});

	this.on('start', function(e){
		self.trigger('linearstart', self);
	});

	this.on('done', function(){
		this.is_done = true;
	});

	var self = this;
	setTimeout(function(){
		self.parse(xml);
	}, 0);
}

LinearCreative.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){
		var self = this;

		this.id = xml.getAttribute('id') || null;
		this.sequence = parseInt(xml.getAttribute('sequence')) || 1;
		this.is_vpaid = (xml.getAttribute('apiFramework') || '').toLowerCase() == 'vpaid';
		this.tracking = parseTrackingEvents(xml.getElementsByTagName('TrackingEvents')[0]);

		if(ad_parameters_xml=xml.getElementsByTagName('AdParameters')[0]){
			this.params.AdParameters = ad_parameters_xml.textContent.trim();
		}

		if(skipoffset_attr=xml.getAttribute('skipoffset')){
			this.skipoffset = parseSkipOffset(skipoffset_attr);
		}

		if(clicks_xml=xml.getElementsByTagName('VideoClicks')[0]){
			if(through_xml = clicks_xml.getElementsByTagName('ClickThrough')[0]){
				this.click_through = through_xml.textContent.trim();
			}

			if(click_tracking_xml=xml.getElementsByTagName('ClickTracking')[0]){
				this.tracking.clickthru = this.tracking.clickthru || [];
				this.tracking.clickthru.push({
					event: 'clickthru',
					content: click_tracking_xml.textContent.trim(),
				});
			}
		}

		map(xml.getElementsByTagName('MediaFile'), function(media_xml){
			var media = new MediaFile(media_xml, {
				is_vpaid: self.is_vpaid,
				creative: self,
			});

			media.proxy([
				'vasterror',
				'vastevent',
				'start',
			], self);

			self.medias.push(media);
		});

		this.trigger('ready');
	},

	show: function(){
		var self = this;

		if(this.medias.length){

			for(var i=0; i<this.medias.length; i++){
				var media = this.medias[i];
				if(media.getIsSupport()){
					this.media = media;
					break;
				}
			}
			if(this.media){
				var p = html('<div style="position:absolute; width:100%; height:100%; top:0; background:black"></div>');
				self.place.appendChild(p);
				this.on('done', function(){
					self.place.removeChild(p);
				});

				if(this.media.is_vpaid){
					this.media.show(p, self.width, self.height, self.vpaid_options);
				}else{
					this.media.show(p, self.width, self.height, self.player_options);
				}

			}else{
				this.trigger('vasterror', 403, 'Couldn\'t find MediaFile that is supported by this video player, based on the attributes of the MediaFile element.', this);
			}
		}else{
			this.trigger('vasterror', 400, 'General Linear error. Video player is unable to display the Linear Ad.', this);
		}
	},

	play: function(){
		this.media.media.player.play();
	},

	pause: function(){
		this.media.media.player.pause();
	},

	skip: function(){
		this.trigger('vastevent', 'skip', {}, this);
	},

	clickthru: function(url){
		this.trigger('vastevent', 'clickthru', {
			click_through: url,
		}, this);
	},

	setVolume: function(volume){
		this.media.media.player.setVolume(volume);
	},

	mute: function(){
		this.media.media.player.mute();
	},

	unmute: function(){
		this.media.media.player.unmute();
	},

});function NonLinear(xml){

	this.place;
	this.elm;

	this.width;
	this.height;
	this.is_vpaid = false;
	this.min_duration;
	this.resource;
	this.click_through;
	this.tracking = [];

	this.can_show = false;
	this.is_error = false;

	this.on('vasterror', function(e, code, message, source){
		this.is_error = true;
	});

	this.on('vastevent', function(e, event, args, source){
		if(event=='clickthru'){
			openWindow(args.click_through);
		}
		processTracking(this.tracking[event]);
	});

	this.parse(xml);
}

NonLinear.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){

		this.is_vpaid = (xml.getAttribute('apiFramework') || '').toLowerCase() == 'vpaid';
		this.width = xml.getAttribute('width') || 0;
		this.height = xml.getAttribute('height') || 0;
		this.tracking = parseTrackingEvents(xml.getElementsByTagName('TrackingEvents')[0]);

		if(min_duration=xml.getAttribute('minSuggestedDuration')){
			if(m = /^(\d{1,2}):(\d{1,2}):(\d{1,2})/.exec(min_duration)){
				this.min_duration = parseInt(m[1])*3600 + parseInt(m[2])*60 + parseInt(m[3]);
			}
		}

		if(click_through_xml = xml.getElementsByTagName("NonLinearClickThrough")[0]){
			this.click_through = click_through_xml.textContent;
		}

		if(click_tracking_xml=xml.getElementsByTagName('NonLinearClickTracking')[0]){
			this.tracking.clickthru = this.tracking.clickthru || [];
			this.tracking.clickthru.push({
				event: 'clickthru',
				content: click_tracking_xml.textContent,
			});
		}

		if(!this.resource && (static_xml=xml.getElementsByTagName('StaticResource')[0])){
			var type = static_xml.getAttribute("creativeType");
			if(this.supportMedia(type)){
				this.resource = {
					type: type,
					src: static_xml.textContent.trim(),
				};
			}
		}
		if(!this.resource && (iframe_xml=xml.getElementsByTagName('IFrameResource')[0])){
			this.resource = {
				type: 'iframe',
				src: iframe_xml.textContent.trim(),
			};
		}
		if(!this.resource && (html_xml=xml.getElementsByTagName('HTMLResource')[0])){
			this.resource = {
				type: 'html',
				src: html_xml.textContent.trim(),
			};
		}

		this.can_show = !!this.resource;
	},

	show: function(place){
		var self = this;

		this.place = place;
		this.elm = html(
			'<div class="nonlinear">'+
				'<div class="close">x</div>'+
				'<div class="inner"></div>'+
			'</div>'
		);
		var close = this.elm.getElementsByClassName('close')[0];
		var inner = this.elm.getElementsByClassName('inner')[0];

		this.elm.style.width = this.width+'px';
		this.elm.style.height = this.height+'px';
		this.elm.style.right = '10px';
		this.elm.style.bottom = '70px';

		var banner = createBanner(this.resource.type, this.resource.src);
		inner.appendChild(banner);

		if(this.click_through){
			on(this.elm, 'click', function(){
				self.trigger('vastevent', 'clickthru', {
					click_through: self.click_through,
				}, self);
			})
		}

		if(this.min_duration){
			close.style.display = 'none';
			setTimeout(function(){
				close.style.display = '';
			}, this.min_duration*1000);
		}

		on(close, 'click', function(){
			self.close();
			return false;
		});

		this.place.appendChild(this.elm);
		this.trigger('vastevent', 'creativeView', {}, this);
	},

	close: function(){
		this.trigger('vastevent', 'collapse', {}, this);
		this.trigger('vastevent', 'close', {}, this);

		this.place.removeChild(this.elm);
	},

	supportMedia: function(type){
		return type!='application/x-shockwave-flash' || flash_support();
	},
});
function NonLinearCreative(xml, options){

	this.place = null;
	extend(this, options);

	this.sequence;
	this.required;
	this.banners = [];

	this.is_ready = false;
	this.is_error = false;

	this.on('ready', function(){
		this.is_ready = true;
	});

	this.on('vasterror', function(e, code, message, source){
		this.is_error = true;
	});

	var self = this;
	setTimeout(function(){
		self.parse(xml);
	}, 0);
}

NonLinearCreative.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){
		var self = this;

		this.sequence = parseInt(xml.getAttribute('sequence')) || 1;

		map(xml.getElementsByTagName('NonLinear'), function(nonlinear_xml){
			var nonlinear = new NonLinear(nonlinear_xml);

			nonlinear.proxy([
				'vasterror',
				'vastevent'
			],self);

			self.banners.push(nonlinear);
		});

		this.trigger('ready');
	},

	show: function(){
		var self = this;

		if(this.banners.length == 0){
			self.trigger('vasterror', 500, 'General NonLinearAds error', self);
			return;
		}

		var current_idx = 0;
		(function(){
			var fn = arguments.callee;
			if(banner=self.banners[current_idx]){
				if(banner.can_show){
					banner.on('close', function(){
						current_idx++;
						fn();
					});
					banner.show(self.place);
				}else{
					self.trigger('vasterror', 503, 'Couldn’t find NonLinear resource with supported type.', self);
					current_idx++;
					fn();
				}
			}else{
				// done
			}
		})();
	}

});function Companion(xml){
	this.place;
	this.width;
	this.height;
	this.resource;
	this.click_through;
	this.tracking = [];

	this.is_error = false;

	this.on('vasterror', function(e, code, message, source){
		this.is_error = true;
	});

	this.on('vastevent', function(e, event, args, source){
		if(event=='clickthru'){
			openWindow(args.click_through);
		}
		processTracking(this.tracking[event]);
	});

	this.parse(xml);
}

Companion.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){

		this.width = xml.getAttribute('width') || 0;
		this.height = xml.getAttribute('height') || 0;
		this.tracking = parseTrackingEvents(xml.getElementsByTagName('TrackingEvents')[0]);

		if(through_xml=xml.getElementsByTagName('CompanionClickThrough')[0]){
			this.click_through = through_xml.textContent;
		}

		if(click_tracking_xml=xml.getElementsByTagName('CompanionClickTracking')[0]){
			this.tracking.clickthru = this.tracking.clickthru || [];
			this.tracking.clickthru.push({
				event: 'clickthru',
				content: click_tracking_xml.textContent,
			});
		}

		if(!this.resource && (static_xml=xml.getElementsByTagName('StaticResource')[0])){
			var type = static_xml.getAttribute("creativeType");
			if(this.supportMedia(type)){
				this.resource = {
					type: type,
					src: static_xml.textContent.trim(),
				};
			}
		}
		if(!this.resource && (iframe_xml=xml.getElementsByTagName('IFrameResource')[0])){
			this.resource = {
				type: 'iframe',
				src: iframe_xml.textContent.trim(),
			};
		}
		if(!this.resource && (html_xml=xml.getElementsByTagName('HTMLResource')[0])){
			this.resource = {
				type: 'html',
				src: html_xml.textContent.trim(),
			};
		}

		if(this.resource && (ad_slot_id=xml.getAttribute('adSlotID'))){
			if(custom_place = document.getElementById(ad_slot_id)){
				if(this.width==custom_place.offsetWidth && this.height==custom_place.offsetHeight){
					this.place = custom_place;
				}
			}
		}
	},

	show: function(){
		var self = this;

		var elm = createBanner(this.resource.type, this.resource.src);
		elm.width = this.width;
		elm.height = this.height;

		if(this.click_through){
			elm.style.cursor = 'pointer';
			on(elm, 'click', function(){
				self.trigger('vastevent', 'clickthru', {
					click_through: self.click_through,
				}, self);
			})
		}

		this.place.innerHTML = '';
		this.place.appendChild(elm);

		self.trigger('vastevent', 'creativeView', {}, this);
	},

	supportMedia: function(type){
		return type!='application/x-shockwave-flash' || flash_support();
	},

});
function CompanionCreative(xml, options){

	this.places = [];
	extend(this, options);

	this.sequence;
	this.required;
	this.banners = [];

	this.is_ready = false;
	this.is_error = false;

	this.on('ready', function(){
		this.is_ready = true;
	});

	this.on('vasterror', function(e, code, message, source){
		this.is_error = true;
	});

	var self = this;
	setTimeout(function(){
		self.parse(xml);
	}, 0);
}

CompanionCreative.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){
		var self = this;

		this.sequence = parseInt(xml.getAttribute('sequence')) || 1;
		this.required = xml.getAttribute('required') || 'any';

		if(this.required!='none'){
			map(xml.getElementsByTagName('Companion'), function(companion_xml){
				var companion = new Companion(companion_xml);

				companion.proxy([
					'vasterror',
					'vastevent'
				],self);

				self.banners.push(companion);
			});
		}
		this.trigger('ready');
	},

	show: function(){
		var self = this;

		if(this.required!='none'){

			var places = [];
			var places_elm = [];

			map(this.places, function(place){
				if(elm = document.getElementById(place.id)){
					places.push(place.width+'x'+place.height);
					places_elm.push(elm);
				}
			});

			map(this.banners, function(banner){
				if(banner.place){
					if((i = places_elm.indexOf(banner.place))>-1){
						places[i] = null;
					}
				}else{
					if((i = places.indexOf(banner.width+'x'+banner.height))>-1){
						places[i] = null;
						banner.place = places_elm[i];
					}
				}

				if(banner.place){
					banner.show();
				}else{
					self.trigger('vasterror', 601, 'Unable to display Companion because creative dimensions do not fit within Companion display area (i.e., no available space).', banner);
					if(self.required=='all'){
						self.trigger('vasterror', 602, 'Unable to display Required Companion', self);
						return false;
					}
				}
			});
		}
	},

});
function Creative(xml, options){

	this.linear_options = {};
	this.nonlinear_options = {};
	this.companion_options = {};
	extend(this, options);

	this.type;
	this.creative;
	this.tracking = {};

	this.is_ready = false;
	this.is_error = false;
	this.is_linear_done = false;

	this.on('ready', function(){
		this.is_ready = true;
	});

	this.on('vasterror', function(e, code, message, source){
		this.is_error = true;
	});

	this.on('vastevent', function(e, event, args, source){
		processTracking(this.tracking[event]);
	});

	this.on('lineardone', function(){
		this.is_linear_done = true;
	});

	var self = this;
	setTimeout(function(){
		self.parse(xml);
	}, 0);
}

Creative.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){
		var self = this;

		this.id = xml.getAttribute('id') || null;
		this.tracking = parseTrackingEvents(creatives_xml.getElementsByTagName('TrackingEvents')[0]);

		if(linear_xml = xml.getElementsByTagName('Linear')[0]){
			this.type = 'linear';
			this.creative = new LinearCreative(linear_xml, this.linear_options);
			this.creative.on(['done', 'error'], function(){
				setTimeout(function(){
					self.trigger('lineardone');
				}, 0);
			});
		}
		else if(nonlinear_xml = xml.getElementsByTagName('NonLinearAds')[0]){
			this.type = 'nonlinear';
			this.creative = new NonLinearCreative(nonlinear_xml, this.nonlinear_options);
		}
		else if(companion_xml = xml.getElementsByTagName('CompanionAds')[0]){
			this.type = 'companion';
			this.creative = new CompanionCreative(companion_xml, this.companion_options);
		}
		else {
			this.trigger('vasterror', 0, '', this);
			return;
		}

		this.creative.proxy([
			'ready',
			'vasterror',
			'vastevent',
			'linearstart',
		], self);
	},

	show: function(){
		var self = this;
		switch(this.type){
			case 'linear':
				this.creative.show();
			break;
			case 'nonlinear':
				this.creative.show();
			break;
			case 'companion':
				this.creative.show();
			break;
		}
	},

});
function InLine(xml, options){

	this.linear_options = {};
	this.nonlinear_options = {};
	this.companion_options = {};
	extend(this, options);

	this.error_url;
	this.impression_url;
	this.tracking = {};

	this.creatives = [];
	this.linear = [];
	this.nonlinear = [];
	this.companion = [];

	this.is_ready = false;
	this.is_error = false;
	this.is_linear_done = false;

	this.on('ready', function(){
		this.is_ready = true;
	});

	this.on('error', function(){
		this.is_error = true;
	});
	
	this.on('lineardone', function(){
		this.is_linear_done = true;
	});

	var self = this;
	setTimeout(function(){
		self.parse(xml);
	}, 0);
}

InLine.prototype = extend(Object.create(CustomObject), {
	
	parse: function(xml){
		var self = this;

		if(error_xml=xml.getElementsByTagName('Error')[0]){
			this.error_url = error_xml.textContent.trim();
		}

		if(impression_xml=xml.getElementsByTagName('Impression')[0]){
			this.impression_url = impression_xml.textContent.trim();
		}

		if(creatives_xml = xml.getElementsByTagName('Creatives')[0]){

			var options = {
				linear_options: self.linear_options,
				nonlinear_options: self.nonlinear_options,
				companion_options: self.companion_options,
			};

			map(creatives_xml.getElementsByTagName('Creative'), function(creative_xml){
				var creative = new Creative(creative_xml, options);
				self.creatives.push(creative);

				creative.on('ready', function(){
					if(creative.type=='linear'){
						self.linear.push(creative);
					}
					if(creative.type=='nonlinear'){
						self.nonlinear.push(creative);
					}
					if(creative.type=='companion'){
						self.companion.push(creative);
					}
					if(every(self.creatives, function(a){return a.is_ready || a.is_error})){
						self.trigger('ready');
					}
				});

				creative.proxy([
					'vasterror',
					'vastevent',
					'linearstart',
				], self);
			});

			this.linear.sort(function(a, b){return a.sequence - b.sequence});
			this.nonlinear.sort(function(a, b){return a.sequence - b.sequence});
			this.companion.sort(function(a, b){return a.sequence - b.sequence});
		}
	},

	start: function(){
		var self = this;
		this.on('lineardone', function(){
			self.startNonLinear();
		});
		this.startCompanion();
		this.startLinear();
	},

	startLinear: function(){
		var self = this;
		var current_idx = 0;

		(function(){
			var fn = arguments.callee;
			if(creative = self.linear[current_idx]){
				creative.on('lineardone', function(){
					current_idx++;
					fn();
				});
				creative.show();
			}else{
				self.trigger('lineardone');
			}
		})();
	},

	startNonLinear: function(){
		map(this.nonlinear, function(creative){
			creative.show();
		});
	},

	startCompanion: function(){
		map(this.companion, function(creative){
			creative.show();
		});
	},
});function Wrapper(xml, options){

	this.linear_options = {};
	this.nonlinear_options = {};
	this.companion_options = {};
	extend(this, options);

	this.vast;

	this.on('ready', function(){
		this.is_ready = true;
	});
	this.on('error', function(){
		this.is_error = true;
	});
	this.on('lineardone', function(){
		this.is_linear_done = true;
	});

	var self = this;
	setTimeout(function(){
		self.parse(xml);
	}, 0);
}

Wrapper.prototype = extend(Object.create(CustomObject), {
	
	parse: function(xml){
		var self = this;
		var url = xml.getElementsByTagName("VASTAdTagURI")[0].textContent;

		this.vast = new VAST(url, {
			linear_options: this.linear_options,
			nonlinear_options: this.nonlinear_options,
			companion_options: this.companion_options,
		});

		this.vast.proxy([
			'ready',
			'error',
			'lineardone',
			'vasterror',
			'vastevent',
			'linearstart',
		], self);
	},

	start: function(){
		this.vast.start();
	},

	startLinear: function(){
		this.vast.startLinear();
	},

	startCompanion: function(){
		this.vast.startCompanion();
	},

	startNonLinear: function(){
		this.vast.startNonLinear();
	},

});
function Ad(xml, options){

	this.linear_options = {};
	this.nonlinear_options = {};
	this.companion_options = {};
	extend(this, options);

	this.id;
	this.sequence;

	this.is_ready = false;
	this.is_error = false;
	this.is_linear_done = false;
	this.is_wrapper = false;

	this.on('ready', function(){
		this.is_ready = true;
	});
	this.on('error', function(){
		this.is_error = true;
	});
	this.on('lineardone', function(){
		this.is_linear_done = true;
	});


	var self = this;
	setTimeout(function(){
		self.parse(xml);
	}, 0);
}

Ad.prototype = extend(Object.create(CustomObject), {

	parse: function(xml){
		var self = this;

		this.id = xml.getAttribute('id') || null;
		this.sequence = parseInt(xml.getAttribute('sequence')) || 1;

		var options = {
			linear_options: self.linear_options,
			nonlinear_options: self.nonlinear_options,
			companion_options: self.companion_options,
		};

		if(wrapper_xml=xml.getElementsByTagName('Wrapper')[0]){
			this.inline = new Wrapper(wrapper_xml, options);
		}else if(inline_xml=xml.getElementsByTagName('InLine')[0]){
			this.inline = new InLine(inline_xml, options);
		}else{
			this.trigger('error');
		}

		this.inline.proxy([
			'ready',
			'linearstart',
			'lineardone',
			'error',
			'vastevent',
			'vasterror'
		], self);
	},

	start: function(){
		this.inline.start();
	},

	startLinear: function(){
		this.inline.startLinear();
	},

	startCompanion: function(){
		this.inline.startCompanion();
	},

	startNonLinear: function(){
		this.inline.startNonLinear();
	},

});
function VAST(url, options){
	var self = this;

	this.timeout = 5000;
	this.linear_options = {
		player_options: {},
		vpaid_options: {
			timeout: 10000,
		},
	};
	this.nonlinear_options = {};
	this.companion_options = {};
	extend(this, options);

	this.url = url;

	this.ads = [];

	this.is_ready = false;
	this.is_error = false;
	this.is_linear_done = false;

	this.load(url);

	this.on('ready', function(){
		this.is_ready = true;
	});
	this.on('error', function(){
		this.is_error = true;
	});
	this.on('lineardone', function(){
		this.is_linear_done = true;
	});
}

VAST.prototype = extend(Object.create(CustomObject), {

	load: function(url){
		var self = this;
		var xhr = null;

		var _t = setTimeout(function(){
			self.trigger('error', 301, 'Timeout of VAST URI provided in Wrapper element');
			xhr.abort();
		}, this.timeout);

		xhr = load(url, function(success, xhr){
			clearTimeout(_t);
			if(success){

				if(!xhr.responseXML || !xhr.responseXML.documentElement){
					self.trigger('error', 100, 'XML parsing error');
					return;
				}

				map(xhr.responseXML.documentElement.getElementsByTagName('Ad'), function(ad_xml){
					var ad = new Ad(ad_xml, {
						linear_options: self.linear_options,
						nonlinear_options: self.nonlinear_options,
						companion_options: self.companion_options,
					});
					
					ad.on('ready', function(){
						if(every(self.ads, function(a){return a.is_ready || a.is_error})){
							self.trigger('ready');
						}
					});

					ad.proxy([
						'linearstart',
						'vastevent',
						'vasterror',
						'error'
					], self);

					self.ads.push(ad);
				});
				if(self.ads.length){
					self.ads.sort(function(a, b){return a.sequence - b.sequence});
				}else{
					self.trigger('error');
				}
			}else{
				self.trigger('error');
			}
		});
	},

	start: function(){
		var self = this;
		this.on('lineardone', function(){
			self.startNonLinear();
		});
		this.startCompanion();
		this.startLinear();
	},

	startLinear: function(){
		var self = this;
		var current_idx = 0;
		(function(){
			var fn = arguments.callee;
			if(ad = self.ads[current_idx]){
				ad.on('lineardone', function(){
					current_idx++;
					fn();
				});
				ad.startLinear();
			}else{
				if(!self.is_linear_done){
					self.trigger('lineardone');
				}
			}
		})();
	},

	startCompanion: function(){
		map(this.ads, function(ad){
			ad.startCompanion();
		});
	},

	startNonLinear: function(){
		map(this.ads, function(ad){
			ad.startNonLinear();
		});
	},

});
function AdControls(options){

	this.creative = null;
	extend(this, options);

	this.player = this.creative.media.media.player;

	this.dom = html(
		'<div class="ad_controls_place">'+
			'<div class="ad-info">'+
				'<span>'+
					'<span class="ad-link">Visit advertiser\'s site</span>'+
					'<span style="margin:0 10px">&bull;</span>'+
				'</span>'+
				'<span class="timer"></span>'+
			'</div>'+
			'<div class="ad-skip"><div class="message"></div></div>'+
			'<div class="controls">'+
				'<div class="progress readonly">'+
					'<div class="load"></div>'+
					'<div class="play"></div>'+
				'</div>'+
				'<div class="play-pause">'+
					'<svg>'+
						'<path class="play" transform="translate(-24, 0)" d="M26,0v24l20-12L26,0L26,0z"/>'+
						'<path class="pause" transform="translate(0, 0)" d="M3.5,0h7v24h-7V0z M13.5,0h7v24h-7V0z"/>'+
					'</svg>'+
				'</div>'+
				'<div class="tray">'+
					'<div class="mute">'+
						'<svg>'+
							'<g class="unmute" transform="translate(-48, 0)">'+
								'<path d="M64.7,2.1L56.3,7h-5.8C49.7,7,49,7.7,49,8.5v7c0,0.8,0.7,1.5,1.5,1.5h5.8l8.4,4.9c1,0.6,2.3-0.1,2.3-1.3V3.4C67,2.3,65.7,1.6,64.7,2.1z"/>'+
								'<path d="M70.4,6.8c-0.1-0.5-0.7-0.9-1.2-0.8c-0.5,0.1-0.9,0.7-0.8,1.2C68.8,8.8,69,10.4,69,12s-0.2,3.2-0.5,4.7c-0.1,0.5,0.2,1.1,0.8,1.2c0.1,0,0.1,0,0.2,0c0.5,0,0.9-0.3,1-0.8c0.4-1.7,0.6-3.4,0.6-5.2S70.8,8.5,70.4,6.8z"/>'+
							'</g>'+
							'<path class="mute" transform="translate(-72, 0)" d="M73,15.5v-7C73,7.7,73.7,7,74.5,7h5.8l8.4-4.9c0.7-0.4,1.5-0.2,1.9,0.4L76.2,17h-1.7C73.7,17,73,16.3,73,15.5z M93.2,6.1c-0.5,0.1-0.9,0.7-0.8,1.2C92.8,8.8,93,10.4,93,12s-0.2,3.2-0.5,4.7c-0.1,0.5,0.2,1.1,0.8,1.2c0.1,0,0.1,0,0.2,0c0.5,0,0.9-0.3,1-0.8c0.4-1.7,0.6-3.4,0.6-5.2s-0.2-3.5-0.6-5.2C94.3,6.3,93.8,6,93.2,6.1z M81.3,17.6l7.5,4.3c1,0.6,2.3-0.1,2.3-1.3V7.8L81.3,17.6z M74.7,22.7l20-20c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-20,20c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3S74.5,22.9,74.7,22.7z"/>'+
						'</svg>'+
					'</div>'+
					'<div class="volume">'+
						'<div class="level"></div>'+
					'</div>'+
				'</div>'+
			'</div>'+
		'</div>'
	);
	this.init();
}

AdControls.prototype = extend(Object.create(CustomObject), {

	init: function(){
		this.initView();
		this.initEvents();
		this.initVolume();
		this.initAdControls();
	},

	getElement: function(){
		return this.dom;
	},

	initView: function(){
		this.dom.style.position = 'absolute';
		this.dom.style.left = 0;
		this.dom.style.right = 0;
		this.dom.style.bottom = 0;
		this.dom.style.top = 0;
	},

	initAdControls: function(){
		var self = this;
		var creative = this.creative;
		var player = this.player;
		var info = this.dom.getElementsByClassName('ad-info')[0];
		var timer = info.getElementsByClassName('timer')[0];
		var skip = this.dom.getElementsByClassName('ad-skip')[0];
		var link = info.firstChild;

		player.on('timeupdate', function(event, time){
			timer.innerHTML = 'Ad. '+self.formatTime(player.getDuration() - time);
		});

		if(creative.click_through){
			on(link, 'click', function(){
				creative.trigger('vastevent', 'clickthru', {
					click_through: creative.click_through,
				}, creative);
			});
		}else{
			link.style.display = 'none';
		}

		if(creative.skipoffset){
			var offset = null;
			if(creative.skipoffset.type=='seconds'){
				offset = creative.skipoffset.value;
			}
			if(creative.skipoffset.type=='percent'){
				offset = player.getDuration() / 100 * creative.skipoffset.value;
			}
			if(offset){
				var message = skip.getElementsByClassName('message')[0];

				player.on('timeupdate', function(event, time){
					if(time>offset){
						event.handler.remove();

						message.innerHTML = "Skip to video";

						on(skip, 'mouseup', function(event){
							creative.trigger('vastevent', 'skip', {}, creative);
							return false;
						});
					}else{
						message.innerHTML = 'You can skip<br>to video<br>in '+parseInt(offset-time);
					}
				});
			}
		}else{
			skip.style.display = 'none';
		}

	},

	initEvents: function(){
		var self = this;

		var play_pause = this.dom.getElementsByClassName('play-pause')[0];
		var progress = this.dom.getElementsByClassName('progress')[0];

		var play_state = 'play';

		this.player.on(['play','resume'], function(){
			play_state = 'play';
			removeClass(self.dom, 'paused');
			addClass(self.dom, 'playing');
			self.delayHide();
		});

		this.player.on('pause', function(){
			play_state = 'pause';
			addClass(self.dom, 'paused');
			removeClass(self.dom, 'playing');
			self.show();
		});

		this.player.on('timeupdate', function(event, time){
			var play = progress.getElementsByClassName("play")[0];
			play.style.width = (time / this.getDuration() * 100) + '%';
		});

		on(this.dom, 'click', function(event){
			if(event.target==self.dom){
				self.trigger(play_state=='play' ? 'pause' : 'play');
			}
		});

		on(play_pause, 'click', function(event){
			self.trigger(play_state=='play' ? 'pause' : 'play');
		});

		on(this.dom, 'mousemove', function(event){
			self.show();
			self.delayHide();
		});
	},

	initVolume: function(){
		var self = this;
		var volume = this.dom.getElementsByClassName('volume')[0];
		var level = volume.getElementsByClassName('level')[0];
		var mute = this.dom.getElementsByClassName('mute')[0];

		level.style.width = '100%';

		on(volume, 'mousedown', function(event){
			if(event.which==1){
				var left = volume.getBoundingClientRect().left;
				self.trigger('volumechange', (event.pageX-left) / volume.offsetWidth);

				on(document, 'mousemove.volume', function(event){
					addClass(volume, 'no-animate');
					self.trigger('volumechange', Math.max(0, Math.min(1, (event.pageX-left) / volume.offsetWidth)));
				});

				on(document, 'mouseup.volume', function(event){
					removeClass(volume, 'no-animate');
					off(document, ['mousemove.volume', 'mouseup.volume']);
				});
			}
		});
		this.player.on('volumechange', function(event, value){
			level.style.width = value*100+'%';
		});
	},

	formatTime: function(time){
		var show_hours = this.player.getDuration() >= 3600;

		var seconds = time | 0;
		var hours = (seconds / 3600) | 0;
		seconds -= hours * 3600;
		var minutes = (seconds / 60) | 0;
		seconds -= minutes * 60;

		return (show_hours ? ('0'+hours).substr(-2)+':' : '') +
			('0'+minutes).substr(-2)+':' +
			('0'+seconds).substr(-2);
	},

	show: function(){
		clearTimeout(this._t);
		this.dom.style.cursor = '';
		addClass(this.dom, 'show');
		removeClass(this.dom, 'hide');
	},

	delayHide: function(){
		var self = this;
		clearTimeout(this._t);
		this._t = setTimeout(function(){
			self.hide();
		}, 2000);
	},

	hide: function(){
		this.dom.style.cursor = 'none';
		addClass(this.dom, 'hide');
		removeClass(this.dom, 'show');
	},

});
function _initControls(creative){
	var ctrl = new AdControls({
		creative: creative,
	});

	var player = creative.media.media.player;

	ctrl.on([
		'play',
		'pause',
	], function(e){
		player[e.type]();
	});

	ctrl.on('volumechange', function(e, volume){
		player.setVolume(volume);
	});

	creative.place.appendChild(ctrl.getElement());
}


function VPAID(){
	this.slot = null;
	this.iframe = null;
	this.vast = null;
	this.tags = [];
	this.tracking = [];

	this.vpaid_timeout = 5;
	this.flash_swf = 'video.swf';
	this.vpaid_flash_bridge = 'vpaid_bridge.swf';
}

VPAID.prototype = {

	_handlers: {},

	trigger: function(eventName){

		console.log('TRIGGER', eventName);

		if(typeof this._handlers[eventName]!=='undefined'){
			for(var i=0; i<this._handlers[eventName].length; i++){
				var h = this._handlers[eventName][i];
				h.handler.apply(h.scope, arguments);
			}
		}
	},

	buildVAST: function(tag){
		var self = this;

		var vast = new VAST(tag.tag, {
			linear_options: {
				place: this.slot,
				width: this.width,
				height: this.height,
				player_options: {
					flash_swf: this.flash_swf,
				},
				vpaid_options: {
					timeout: this.vpaid_timeout * 1000,
					vpaid_flash_bridge: this.vpaid_flash_bridge,
				}
			},
		});

		vast.on('*', function(e){
			console.log('>>>', e.type);
		});

		vast.on('vasterror', function(e, code, msg, source){
			console.log('vasterror', code, msg);
		});

		vast.on('vastevent', function(e, event, args, source){

			console.log(event, args, source);

			map(self.tracking, function(tr){
				if(tr.event==event || tr.event=='*'){
					firePixel(tr.pixel, {
						'AD': tag.id,
						'EVENT': event,
						'SITE': document.referrer,
						'FLASH': '',
					});
				}
			});
		});

		vast.on('linearstart', function(e, creative){
			if(!creative.is_vpaid){
				_initControls(creative);
			}
		});

		return vast;
	},

	///////////////////////////////

	handshakeVersion: function(v){
		return '2.0';
	},

	initAd: function(width, height, viewMode, desiredBitrate, creativeData, environmentVars){
		var self = this;

		this.width = width;
		this.height = height;

		if(creativeData.AdParameters){
			try {
				var AdParameters = JSON.parse(creativeData.AdParameters);
				this.tags = AdParameters.ads;
				this.tracking = AdParameters.tracking;
				this.vpaid_timeout = AdParameters.timeout || this.vpaid_timeout;
				this.flash_swf = AdParameters.video_swf || this.flash_swf;
				this.vpaid_flash_bridge = AdParameters.vpaid_bridge_swf || this.vpaid_flash_bridge;

				if(environmentVars.slot){
					this.slot = environmentVars.slot;
					document.body.setAttribute('style', 'margin:0; padding:0');

					this.trigger('AdLoaded');
					return;	
				}
			}catch(e){
				console.error(e.message);
			}
		}
		this.trigger('AdError');
	},

	startAd: function(){
		var self = this;
		var current_idx = 0;
		var has_started = false;
		(function(){
			var fn = arguments.callee;
			if(tag = self.tags[current_idx]){
				self.current_vast = self.buildVAST(tag);
				self.current_vast.on('ready', function(){
					if(!has_started){
						has_started = true;
						self.trigger('AdStarted');
					}
					this.startLinear();
				});
				self.current_vast.on(['lineardone','error'], function(){
					current_idx++;
					fn();
				});
			}else{
				self.trigger('AdStopped');
			}
		})();
	},

	getAdDuration: function(){

	},

	getAdLinear: function(){
		return true;
	},

	stopAd: function(e, p){

	},

	setAdVolume: function(val){

	},

	getAdVolume: function(){

	},

	resizeAd: function(width, height, viewMode){

	},

	pauseAd: function(){

	},

	resumeAd: function(){

	},

	expandAd: function(){

	},

	getAdExpanded: function(){

	},

	getAdSkippableState: function(){

	},

	collapseAd: function(){

	},

	skipAd: function(){

	},

	subscribe: function(aCallback, eventName, aContext){
		this._handlers[eventName] = this._handlers[eventName] || [];
		this._handlers[eventName].push({
			handler: aCallback,
			scope: aContext,
		});
	},

	unsubscribe: function(eventName){
		this._handlers[eventName] = [];
	},

};	return new VPAID;
};